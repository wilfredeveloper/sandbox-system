version: '3.8'

services:
  # Redis for session coordination
  redis:
    image: redis:7-alpine
    container_name: sandbox-redis
    ports:
      - "220105:6379"  # Dev Redis (shared with backend, or use separate instance)
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Coordinator / Load Balancer
  coordinator:
    build:
      context: .
      dockerfile: Dockerfile.coordinator
    container_name: sandbox-coordinator
    ports:
      - "220110:8000"  # Dev Sandbox Coordinator (SERVICE_ID=10)
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - WORKERS=http://worker1:5000,http://worker2:5000
      - PORT=8000
    depends_on:
      - redis
      - worker1
      - worker2
    restart: unless-stopped

  # Worker 1 - Optimized for 24GB RAM Contabo server
  worker1:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: sandbox-worker1
    privileged: true  # Required for Docker-in-Docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Share host Docker socket
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - WORKER_ID=worker1
      - PORT=5000
      # Pool configuration
      - POOL_SIZE=20
      - MIN_POOL_SIZE=5
      - MAX_POOL_SIZE=40
      # Resource limits (optimized for AI agent bash execution)
      - MEMORY_LIMIT=256m
      - CPU_QUOTA=25000
      # Timeout configuration
      - SESSION_TIMEOUT_MINUTES=15
      - CONTAINER_IDLE_TIMEOUT_MINUTES=5
      - CLEANUP_INTERVAL_SECONDS=300
      # Aggressive cleanup for resource efficiency
      - AGGRESSIVE_CLEANUP=true
      - POOL_REFILL_DELAY_SECONDS=60
    depends_on:
      - redis
    restart: unless-stopped

  # Worker 2 - Optimized for 24GB RAM Contabo server
  worker2:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: sandbox-worker2
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - WORKER_ID=worker2
      - PORT=5000
      # Pool configuration
      - POOL_SIZE=20
      - MIN_POOL_SIZE=5
      - MAX_POOL_SIZE=40
      # Resource limits (optimized for AI agent bash execution)
      - MEMORY_LIMIT=256m
      - CPU_QUOTA=25000
      # Timeout configuration
      - SESSION_TIMEOUT_MINUTES=15
      - CONTAINER_IDLE_TIMEOUT_MINUTES=5
      - CLEANUP_INTERVAL_SECONDS=300
      # Aggressive cleanup for resource efficiency
      - AGGRESSIVE_CLEANUP=true
      - POOL_REFILL_DELAY_SECONDS=60
    depends_on:
      - redis
    restart: unless-stopped

volumes:
  redis-data:
    driver: local

networks:
  default:
    name: sandbox-network
